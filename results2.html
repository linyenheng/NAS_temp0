<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive SST Analysis</title>
    <script src="https://unpkg.com/netcdfjs@0.5.0/dist/netcdf.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 10px; text-decoration: none; color: blue; }
        .section { margin-bottom: 20px; }
        .control-group { margin-bottom: 15px; }
        select, input { margin: 5px; }
        #plot { width: 100%; height: 500px; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="#introduction">Introduction</a>
        <a href="#results">Results</a>
        <a href="#results2">Results 2</a>
        <a href="#references">References</a>
        <a href="#contact">Contact</a>
    </div>

    <h1>Interactive SST Analysis</h1>

    <div class="section">
        <p>Loading ERSST data from data_use/ersst.mnmean.nc...</p>
    </div>

    <div class="section">
        <div class="control-group">
            <label>Select Plot Type:</label><br>
            <select id="plotType">
                <option value="timeseries">Time Series</option>
                <option value="simplemap">Map (Simple)</option>
                <option value="geomap">Geographic Map (with Coastlines)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Latitude Range:</label><br>
            From: <input type="number" id="latMin" value="-90" min="-90" max="90"> °N to:
            <input type="number" id="latMax" value="90" min="-90" max="90"> °N
            <p>Auto-maps to nearest available data points</p>
        </div>

        <div class="control-group">
            <label>Longitude Range:</label><br>
            From: <input type="number" id="lonMin" value="0" min="0" max="360"> °E to:
            <input type="number" id="lonMax" value="360" min="0" max="360"> °E
            <p>Auto-maps to nearest available data points</p>
        </div>

        <div class="control-group">
            <label>Time Period:</label><br>
            From: <input type="number" id="timeMin" value="1854"> to:
            <input type="number" id="timeMax" value="2023">
        </div>

        <div class="control-group">
            <label>Select Statistic:</label><br>
            <select id="statistic">
                <option value="mean">Mean</option>
                <option value="std">Standard Deviation</option>
            </select>
        </div>

        <button onclick="updatePlot()">Update Plot</button>
    </div>

    <div class="section">
        <div id="plot"></div>
    </div>

    <div class="section">
        <h3>Data Source</h3>
        <p>This tool loads real ERSST data from: data_use/ersst.mnmean.nc</p>
        <p>Make sure the NetCDF file is uploaded to your repository at that location.</p>
    </div>

    <div class="section">
        <h3>Data Information:</h3>
        <p id="dataInfo"></p>
    </div>

    <script>
        let sstData = null;
        let lat = null;
        let lon = null;
        let time = null;

        // Load NetCDF file
        fetch('data_use/ersst.mnmean.nc')
            .then(response => response.arrayBuffer())
            .then(buffer => {
                const reader = new netcdfjs.NetCDFReader(buffer);
                sstData = reader.getDataVariable('sst')[0]; // Assuming sst is 3D: [time, lat, lon]
                lat = reader.getDataVariable('lat');
                lon = reader.getDataVariable('lon');
                time = reader.getDataVariable('time'); // Assuming time in years or months
                document.getElementById('dataInfo').innerText = `Loaded data: ${lat.length} latitudes, ${lon.length} longitudes, ${time.length} time points`;
            })
            .catch(error => {
                console.error('Error loading NetCDF:', error);
                document.getElementById('dataInfo').innerText = 'Error loading NetCDF file';
            });

        function updatePlot() {
            if (!sstData) {
                alert('Data not yet loaded');
                return;
            }

            const plotType = document.getElementById('plotType').value;
            const latMin = parseFloat(document.getElementById('latMin').value);
            const latMax = parseFloat(document.getElementById('latMax').value);
            const lonMin = parseFloat(document.getElementById('lonMin').value);
            const lonMax = parseFloat(document.getElementById('lonMax').value);
            const timeMin = parseFloat(document.getElementById('timeMin').value);
            const timeMax = parseFloat(document.getElementById('timeMax').value);
            const statistic = document.getElementById('statistic').value;

            // Find indices for lat, lon, time ranges
            const latIndices = lat.map((v, i) => v >= latMin && v <= latMax ? i : -1).filter(i => i !== -1);
            const lonIndices = lon.map((v, i) => v >= lonMin && v <= lonMax ? i : -1).filter(i => i !== -1);
            const timeIndices = time.map((v, i) => v >= timeMin && v <= timeMax ? i : -1).filter(i => i !== -1);

            if (latIndices.length === 0 || lonIndices.length === 0 || timeIndices.length === 0) {
                alert('Invalid range selection');
                return;
            }

            // Extract data subset
            const dataSubset = latIndices.map(() => lonIndices.map(() => []));
            timeIndices.forEach(t => {
                latIndices.forEach((latIdx, i) => {
                    lonIndices.forEach((lonIdx, j) => {
                        dataSubset[i][j].push(sstData[t][latIdx][lonIdx]);
                    });
                });
            });

            // Compute statistic
            const plotData = dataSubset.map(row => row.map(col => {
                if (statistic === 'mean') {
                    return col.reduce((sum, val) => sum + val, 0) / col.length;
                } else {
                    const mean = col.reduce((sum, val) => sum + val, 0) / col.length;
                    return Math.sqrt(col.reduce((sum, val) => sum + (val - mean) ** 2, 0) / col.length);
                }
            }));

            const latSubset = latIndices.map(i => lat[i]);
            const lonSubset = lonIndices.map(i => lon[i]);

            // Plot based on type
            let trace;
            if (plotType === 'timeseries') {
                const timeSeries = timeIndices.map(t => {
                    let sum = 0, count = 0;
                    latIndices.forEach(latIdx => {
                        lonIndices.forEach(lonIdx => {
                            sum += sstData[t][latIdx][lonIdx];
                            count++;
                        });
                    });
                    return sum / count;
                });
                trace = [{
                    x: timeIndices.map(i => time[i]),
                    y: timeSeries,
                    type: 'scatter',
                    mode: 'lines'
                }];
            } else if (plotType === 'simplemap') {
                trace = [{
                    z: plotData,
                    x: lonSubset,
                    y: latSubset,
                    type: 'heatmap'
                }];
            } else if (plotType === 'geomap') {
                trace = [{
                    z: plotData,
                    x: lonSubset,
                    y: latSubset,
                    type: 'contour',
                    colorscale: 'Viridis',
                    contours: { coloring: 'fill', showlines: true },
                    geo: {
                        showcoastlines: true,
                        coastlinecolor: 'black',
                        showland: true,
                        landcolor: 'lightgray'
                    }
                }];
            }

            const layout = {
                title: `SST ${statistic === 'mean' ? 'Mean' : 'Standard Deviation'} (${plotType})`,
                xaxis: { title: plotType === 'timeseries' ? 'Time' : 'Longitude' },
                yaxis: { title: plotType === 'timeseries' ? 'SST (°C)' : 'Latitude' }
            };

            Plotly.newPlot('plot', trace, layout);
        }
    </script>
</body>
</html>
