<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Results 2: SST Visualization</title>
  <!-- Tailwind for layout -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- NetCDF.js for reading .nc files -->
  <script src="https://unpkg.com/netcdfjs@1.3.2/dist/netcdf.min.js"></script>
  <style>
    #plot { width: 100%; max-width: 800px; margin: 20px auto; height: 600px; }
    #status { padding: 10px; margin: 10px 0; border-radius: 4px; text-align: center; }
    .loading { background-color: #fef3c7; color: #92400e; }
    .error   { background-color: #fecaca; color: #991b1b; }
    .success { background-color: #d1fae5; color: #065f46; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <nav class="bg-blue-600 text-white p-4">
    <ul class="flex space-x-6 justify-center">
      <li><a href="index.html" class="hover:underline">Introduction</a></li>
      <li><a href="results.html" class="hover:underline">Results</a></li>
      <li><a href="results2.html" class="font-bold">Results 2</a></li>
      <li><a href="references.html" class="hover:underline">References</a></li>
      <li><a href="contact.html" class="hover:underline">Contact</a></li>
    </ul>
  </nav>

  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Interactive SST Analysis</h1>

    <div id="status" class="loading">Status: Loading ERSST data...</div>

    <!-- Plot type & statistic controls -->
    <div id="controls" class="hidden mb-6">
      <div class="flex items-center gap-4">
        <div>
          <label for="plotTypeSelect" class="block text-sm font-medium">Plot Type</label>
          <select id="plotTypeSelect" class="p-2 border rounded">
            <option value="map">Map</option>
            <option value="timeseries">Time Series</option>
          </select>
        </div>
        <div id="statisticDiv">
          <label for="statisticSelect" class="block text-sm font-medium">Statistic</label>
          <select id="statisticSelect" class="p-2 border rounded">
            <option value="mean">Mean</option>
            <option value="std">Std Dev</option>
          </select>
        </div>
        <button id="updateBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update Plot</button>
      </div>
    </div>

    <!-- Plot container -->
    <div id="plot"></div>

    <!-- Data information -->
    <div id="dataInfo" class="mt-6 p-4 bg-gray-50 rounded hidden">
      <h3 class="font-semibold mb-2">Data Information:</h3>
      <div id="dataDetails"></div>
    </div>
  </div>

  <script>
    let latData, lonData, timeData, sstData;
    let nlat, nlon, ntime;

    function updateStatus(msg, type = 'loading') {
      const el = document.getElementById('status');
      el.textContent = 'Status: ' + msg;
      el.className = type;
    }

    function showDataInfo() {
      const info = document.getElementById('dataInfo');
      info.classList.remove('hidden');
      document.getElementById('dataDetails').innerHTML = `
        <p><strong>Time Steps:</strong> ${ntime}</p>
        <p><strong>Latitude Points:</strong> ${nlat}</p>
        <p><strong>Longitude Points:</strong> ${nlon}</p>
        <p><strong>Total Grid Cells:</strong> ${nlat * nlon}</p>
      `;
      document.getElementById('controls').classList.remove('hidden');
    }

    async function loadData() {
      try {
        const url = './data_use/ersst.mnmean.nc';
        const resp = await fetch(url);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        updateStatus('Parsing NetCDF data...');
        const buffer = await resp.arrayBuffer();
        const reader = new netcdfjs.NetCDFReader(buffer);

        const latVar  = reader.variables.find(v => /lat/i.test(v.name));
        const lonVar  = reader.variables.find(v => /lon/i.test(v.name));
        const timeVar = reader.variables.find(v => /time/i.test(v.name));
        const sstVar  = reader.variables.find(v => /sst/i.test(v.name));
        if (!latVar || !lonVar || !timeVar || !sstVar) {
          throw new Error('Missing lat/lon/time/sst variables in file');
        }

        latData  = reader.getDataVariable(latVar);
        lonData  = reader.getDataVariable(lonVar);
        timeData = reader.getDataVariable(timeVar).map(d => {
          const dt = new Date(1800, 0, 1);
          dt.setDate(dt.getDate() + d);
          return dt.getFullYear();
        });
        sstData  = reader.getDataVariable(sstVar);

        nlat = latData.length;
        nlon = lonData.length;
        ntime = timeData.length;

        updateStatus('Data loaded successfully!', 'success');
        showDataInfo();
        updatePlot();
      } catch (err) {
        console.error(err);
        updateStatus(`Error loading data: ${err.message}`, 'error');
      }
    }

    function updatePlot() {
      const stat = document.getElementById('statisticSelect').value;
      const plotType = document.getElementById('plotTypeSelect').value;
      updateStatus(`Plotting ${plotType} (${stat})...`);
      const gridSize = nlat * nlon;

      if (plotType === 'map') {
        const mapData = Array.from({ length: nlat }, () => Array(nlon).fill(NaN));
        for (let i = 0; i < nlat; i++) {
          for (let j = 0; j < nlon; j++) {
            const vals = [];
            for (let t = 0; t < ntime; t++) {
              const idx = t * gridSize + i * nlon + j;
              const v = sstData[idx];
              if (isFinite(v)) vals.push(v);
            }
            if (vals.length) {
              const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
              mapData[i][j] = (stat === 'mean')
                ? mean
                : Math.sqrt(vals.reduce((sum, v) => sum + (v - mean) ** 2, 0) / vals.length);
            }
          }
        }

        Plotly.newPlot('plot', [{
          z: mapData,
          x: lonData,
          y: latData,
          type: 'contour',
          contours: { coloring: 'fill', showlabels: true, labelfont: { size: 12, color: 'black' } },
          colorscale: 'Viridis',
          colorbar: { title: stat === 'mean' ? 'SST (°C)' : 'SST Std Dev (°C)' }
        }], {
          title: `${stat === 'mean' ? 'Mean' : 'Std Dev'} SST Contour`, xaxis: { title: 'Longitude' }, yaxis: { title: 'Latitude' }
        });

      } else {
        const ts = [];
        for (let t = 0; t < ntime; t++) {
          const vals = [];
          for (let i = 0; i < gridSize; i++) {
            const v = sstData[t * gridSize + i];
            if (isFinite(v)) vals.push(v);
          }
          if (vals.length) {
            const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
            ts.push(stat === 'mean' ? mean : Math.sqrt(vals.reduce((sum, v) => sum + (v - mean) ** 2, 0) / vals.length));
          } else ts.push(NaN);
        }

        Plotly.newPlot('plot', [{ x: timeData, y: ts, mode: 'lines+markers', type: 'scatter',
          name: stat === 'mean' ? 'Mean SST' : 'SST Std Dev' }], {
          title: `Time Series of ${stat === 'mean' ? 'Mean' : 'Std Dev'} SST`, xaxis: { title: 'Year' }, yaxis: { title: 'SST (°C)' }
        });
      }
      updateStatus('Plot ready!', 'success');
    }

    // Event listeners
    document.getElementById('updateBtn').addEventListener('click', updatePlot);
    document.getElementById('plotTypeSelect').addEventListener('change', updatePlot);
    document.getElementById('statisticSelect').addEventListener('change', updatePlot);

    // Load default NetCDF on page load
    window.addEventListener('load', loadData);
  </script>
</body>
</html>

